# Backlog MVP
## Проект: TG Freelance Mini App
## Источник требований: `TZ_TG_FREELANCE_MINIAPP.md`
## Дата: 2026-02-21

## 1. Статусы и приоритеты
- Статусы задач: `TODO`, `IN_PROGRESS`, `REVIEW`, `DONE`, `BLOCKED`
- Приоритеты: `P0` (критично для MVP), `P1` (желательно в MVP), `P2` (после MVP)

## 2. Definition of Ready (DoR)
- Есть ссылка на требование из ТЗ.
- Понятны API/данные, которые нужны для задачи.
- Понятны критерии приемки.
- Нет внешних блокеров.

## 3. Definition of Done (DoD)
- Код написан и проходит локальные проверки.
- Закрыты критерии приемки задачи.
- Обновлена документация (если менялся контракт/API/поведение).
- Негативные кейсы обработаны (валидация/права/ошибки).

## 4. Эпики и задачи

## EPIC-0: Foundation и инфраструктура
Цель: подготовить каркас проекта для быстрой реализации MVP.
Приоритет: `P0`

Задачи:
- `E0-T1` Инициализировать backend (Node.js + TypeScript + Express/NestJS), настроить env и структуру модулей.
- `E0-T2` Поднять PostgreSQL и миграции (Prisma), создать базовые enum и таблицы.
- `E0-T3` Инициализировать frontend (React + Vite + TypeScript), подключить Telegram WebApp SDK.
- `E0-T4` Настроить единый формат ошибок API и базовый логгер.
- `E0-T5` Подготовить базовый CI: lint + typecheck + тесты.

Чеклист приемки:
- [ ] Запуск frontend и backend одной командой (или через documented команды).
- [ ] Подключение к БД работает, миграции применяются.
- [ ] В API есть health endpoint (`GET /health`).
- [ ] Ошибки API возвращаются в едином формате из ТЗ.

---

## EPIC-1: Авторизация Telegram и профиль
Цель: безопасный вход пользователя и управление профилем.
Приоритет: `P0`
Зависимости: `EPIC-0`

Задачи:
- `E1-T1` Реализовать `POST /auth/telegram` с валидацией `initData` по токену бота.
- `E1-T2` Реализовать `GET /auth/me`.
- `E1-T3` Создание/обновление пользователя (`users`) и профиля (`profiles`) при логине.
- `E1-T4` Реализовать `GET /profile/me` и `PATCH /profile/me`.
- `E1-T5` Реализовать `GET /profile/:userId`.
- `E1-T6` На фронте: bootstrap WebApp, авто-логин, экран профиля.

Чеклист приемки:
- [ ] Невалидный `initData` отклоняется.
- [ ] Валидный `initData` создает/обновляет пользователя.
- [ ] Пользователь может менять `display_name`, `about`, `skills`.
- [ ] Эндпоинты профиля защищены авторизацией.

---

## EPIC-2: Задачи и лента
Цель: заказчик публикует задачи, исполнители просматривают и фильтруют.
Приоритет: `P0`
Зависимости: `EPIC-1`

Задачи:
- `E2-T1` Реализовать `POST /tasks`.
- `E2-T2` Реализовать `GET /tasks` (пагинация, фильтры, сортировка).
- `E2-T3` Реализовать `GET /tasks/:id`.
- `E2-T4` Реализовать `PATCH /tasks/:id` (только владелец и только `OPEN`).
- `E2-T5` Реализовать `POST /tasks/:id/cancel`.
- `E2-T6` Фронт: экран ленты с фильтрами.
- `E2-T7` Фронт: создание/редактирование задачи.
- `E2-T8` Фронт: карточка задачи.

Чеклист приемки:
- [ ] Создание задачи с валидными полями успешно.
- [ ] Невалидные поля дают корректные `VALIDATION_ERROR`.
- [ ] Поиск и фильтры по категории/бюджету/тексту работают.
- [ ] Чужую задачу редактировать нельзя.
- [ ] Отмененная задача получает статус `CANCELED`.

---

## EPIC-3: Отклики и выбор исполнителя
Цель: исполнитель откликается, заказчик выбирает одного исполнителя.
Приоритет: `P0`
Зависимости: `EPIC-2`

Задачи:
- `E3-T1` Реализовать `POST /tasks/:id/proposals`.
- `E3-T2` Реализовать `GET /tasks/:id/proposals` (контроль прав).
- `E3-T3` Реализовать `PATCH /proposals/:id`.
- `E3-T4` Реализовать `DELETE /proposals/:id`.
- `E3-T5` Реализовать `POST /tasks/:id/select-proposal`.
- `E3-T6` Реализовать бизнес-ограничения:
  - нельзя откликаться на свою задачу,
  - один отклик от исполнителя на задачу,
  - после выбора исполнителя новые отклики запрещены.
- `E3-T7` Фронт: экран откликов заказчика.
- `E3-T8` Фронт: форма отклика исполнителя.

Чеклист приемки:
- [ ] Исполнитель может оставить ровно один отклик на задачу.
- [ ] Заказчик видит все отклики по своей задаче.
- [ ] Выбор исполнителя переводит задачу в `IN_PROGRESS`.
- [ ] После выбора нельзя создать/обновить отклик.

---

## EPIC-4: Завершение задачи и история статусов
Цель: пройти жизненный цикл от `IN_PROGRESS` до `COMPLETED`.
Приоритет: `P0`
Зависимости: `EPIC-3`

Задачи:
- `E4-T1` Реализовать `POST /tasks/:id/send-to-review` (исполнитель).
- `E4-T2` Реализовать `POST /tasks/:id/approve` (заказчик).
- `E4-T3` Реализовать `POST /tasks/:id/reject-review` (заказчик).
- `E4-T4` Реализовать `task_status_history` (автоматическая запись переходов).
- `E4-T5` Фронт: кнопки статусов для заказчика/исполнителя в карточке задачи.
- `E4-T6` Фронт: отображение истории изменений статуса.

Чеклист приемки:
- [ ] Только назначенный исполнитель может отправить в `ON_REVIEW`.
- [ ] Только заказчик может подтвердить (`COMPLETED`) или отклонить.
- [ ] Все переходы статусов логируются в `task_status_history`.
- [ ] После `COMPLETED` изменения задачи/откликов запрещены.

---

## EPIC-5: Нефункциональные требования и админ-функции
Цель: довести MVP до эксплуатационного минимума.
Приоритет: `P1`
Зависимости: `EPIC-1`, `EPIC-2`, `EPIC-3`, `EPIC-4`

Задачи:
- `E5-T1` Добавить rate limit на создание задач и откликов.
- `E5-T2` Усилить аудит-логирование (логин, смена статусов, ошибки 4xx/5xx).
- `E5-T3` Реализовать минимальную админ-панель/эндпоинт блокировки пользователя.
- `E5-T4` Добавить внутренние уведомления в приложении.
- `E5-T5` Прогон smoke/nreg сценариев MVP.

Чеклист приемки:
- [ ] Блокированный пользователь не может создавать задачи и отклики.
- [ ] Ключевые действия логируются.
- [ ] Минимальные уведомления о новом отклике/выборе исполнителя/смене статуса работают.

## 5. Бэклог тестирования (обязательный минимум)
- `QA-T1` Авторизация: валидный/невалидный `initData`.
- `QA-T2` Права доступа: чужие задачи/чужие отклики.
- `QA-T3` Переходы статусов по ролям.
- `QA-T4` Идемпотентность и повторные действия.
- `QA-T5` Фильтры и пагинация в `GET /tasks`.
- `QA-T6` Блокировка пользователя.

Критерий готовности тестового блока:
- [ ] Все `QA-T*` пройдены на staging.
- [ ] Критичных дефектов (`P0`) нет.

## 6. Релизный план (предложение)
- Sprint 1: `EPIC-0` + `EPIC-1`
- Sprint 2: `EPIC-2`
- Sprint 3: `EPIC-3`
- Sprint 4: `EPIC-4` + `EPIC-5`

## 7. Что брать в работу в первую очередь (сегодня)
- `E0-T1`
- `E0-T2`
- `E1-T1`
- `E1-T2`

## 8. Текущий прогресс
- [x] `E0-T1` Инициализирован backend-каркас (`Express + TypeScript`, env, модульная структура, `GET /health`).
- [x] `E0-T2` Поднят PostgreSQL (docker compose), подключен Prisma, создана и применена миграция `init`.
- [x] `E0-T3` Инициализирован frontend (`React + Vite + TypeScript`), подключен Telegram WebApp SDK, добавлен базовый Mini App shell.
- [x] `E0-T4` Введены `request-id`, централизованный формат ошибок и структурное логирование запросов/ошибок.
- [ ] `E0-T5` Частично: добавлены GitHub Actions для CI (`backend/frontend checks`) и autodeploy frontend+backend на VPS; тесты пока не добавлены.
- [x] `E1-T1` Реализован `POST /auth/telegram` с проверкой подписи `initData`.
- [x] `E1-T2` Реализован `GET /auth/me` по Bearer-токену.
- [x] `E1-T3` На логине выполняется upsert `users` и `profiles`.
- [x] `E1-T4` Реализованы `GET /profile/me` и `PATCH /profile/me`.
- [x] `E1-T5` Реализован `GET /profile/:userId`.
- [x] `E2-T1` Реализован `POST /tasks`.
- [x] `E2-T2` Реализован `GET /tasks` (пагинация, фильтры, сортировка).
- [x] `E2-T3` Реализован `GET /tasks/:id`.
- [x] `E2-T4` Реализован `PATCH /tasks/:id` (только владелец и только `OPEN`).
- [x] `E2-T5` Реализован `POST /tasks/:id/cancel`.
- [x] `E2-T6` На фронте реализован экран ленты задач с фильтрами и пагинацией.
- [x] `E2-T7` На фронте реализованы создание и редактирование задачи.
- [x] `E2-T8` На фронте реализована карточка задачи с детальным просмотром и отменой для владельца.
- [x] `E3-T1` Реализован `POST /tasks/:id/proposals`.
- [x] `E3-T2` Реализован `GET /tasks/:id/proposals` с контролем прав (владелец задачи/автор отклика).
- [x] `E3-T3` Реализован `PATCH /proposals/:id`.
- [x] `E3-T4` Реализован `DELETE /proposals/:id`.
- [x] `E3-T5` Реализован `POST /tasks/:id/select-proposal` (выбор исполнителя, перевод задачи в `IN_PROGRESS`).
- [x] `E3-T6` Реализованы бизнес-ограничения откликов (`не на свою задачу`, `один отклик`, запрет создания/изменения/удаления после выбора исполнителя).
- [x] `E3-T7` На фронте реализован экран откликов заказчика в карточке задачи (просмотр и выбор исполнителя).
- [x] `E3-T8` На фронте реализована форма отклика исполнителя (создание/редактирование/удаление).
- [x] `E4-T1` Реализован `POST /tasks/:id/send-to-review` (только назначенный исполнитель, только для `IN_PROGRESS`).
- [x] `E4-T2` Реализован `POST /tasks/:id/approve` (только владелец задачи, только для `ON_REVIEW`).
- [x] `E4-T3` Реализован `POST /tasks/:id/reject-review` (только владелец задачи, только для `ON_REVIEW`, с обязательным комментарием).
- [x] `E4-T4` Добавлена автоматическая запись переходов в `task_status_history` (создание задачи, выбор исполнителя, отправка на проверку, подтверждение, отклонение проверки, отмена задачи).
- [x] `E4-T5` На фронте добавлены кнопки смены статуса в карточке задачи (`send-to-review`, `approve`, `reject-review`).
- [x] `E4-T6` На фронте добавлено отображение истории переходов статуса задачи.
- [x] `E5-T1` Добавлен in-memory rate limit на создание задач и откликов (`POST /tasks`, `POST /tasks/:id/proposals`).
- [x] `E5-T2` Усилено audit-логирование (`audit.auth_login`, `audit.task_status_changed`, `audit.http_error_4xx`, `audit.http_error_5xx`).
- [x] `E5-T3` Добавлен admin-эндпоинт блокировки пользователя `PATCH /admin/users/:userId/block` (с проверкой admin-доступа).
- [x] `E5-T4` Добавлены внутренние уведомления (backend API + создание на ключевых событиях + блок на фронте).
