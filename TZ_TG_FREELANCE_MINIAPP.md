# Техническое задание (ТЗ)
## Проект: Telegram Mini App «TG Freelance»
## Версия: 1.0
## Дата: 2026-02-21

## 1. Цель проекта
Сделать Telegram Mini App для публикации фриланс-задач, откликов исполнителей и выбора исполнителя заказчиком.

MVP должен позволять закрыть полный базовый цикл:
1. Заказчик создает задачу.
2. Исполнители оставляют отклики.
3. Заказчик выбирает исполнителя.
4. Задача проходит статусы до завершения.

## 2. Платформы и ограничения
1. Клиент: Telegram Mini App (WebApp внутри Telegram).
2. Доступ: только авторизованные пользователи Telegram.
3. Язык интерфейса MVP: русский.
4. Поддержка устройств: мобильный Telegram (iOS/Android), Telegram Desktop.

## 3. Роли пользователей
1. Гость: отсутствует (вход только через Telegram).
2. Пользователь:
- может выступать заказчиком (создает задачи),
- может выступать исполнителем (оставляет отклики).
3. Администратор (MVP-light):
- просмотр пользователей и задач,
- ручная блокировка пользователя при жалобах/спаме.

## 4. Основные сущности
1. Пользователь (`user`)
2. Профиль (`profile`)
3. Задача (`task`)
4. Отклик (`proposal`)
5. Назначение исполнителя (`assignment`)
6. Статус задачи (`task_status_history`)
7. Жалоба (`report`) — опционально для MVP, но структура закладывается.

## 5. Функциональные требования (MVP)
### 5.1 Авторизация через Telegram
1. Приложение получает `initData` из Telegram WebApp.
2. Бэкенд валидирует подпись `initData` по токену бота.
3. При успешной валидации создается/обновляется пользователь.
4. Пользователь получает сессионный токен приложения (JWT/opaque token).

### 5.2 Профиль пользователя
1. Просмотр профиля:
- `telegram_id`,
- `username`,
- `display_name`,
- `about`,
- `skills` (список тегов),
- рейтинг (заглушка для MVP).
2. Редактирование `display_name`, `about`, `skills`.

### 5.3 Создание и управление задачами (заказчик)
1. Поля задачи:
- заголовок (обяз.),
- описание (обяз.),
- бюджет (обяз., число > 0),
- дедлайн (опц.),
- категория (обяз.),
- теги (опц.),
- тип оплаты: фикс / почасовая (MVP можно только фикс).
2. Заказчик может:
- создать задачу,
- отредактировать задачу, пока нет назначения исполнителя,
- закрыть задачу без выбора исполнителя.

### 5.4 Лента и поиск задач (исполнитель)
1. Список открытых задач.
2. Фильтры:
- категория,
- бюджет от/до,
- поиск по тексту (заголовок/описание).
3. Сортировка:
- новые,
- по бюджету.

### 5.5 Отклики исполнителей
1. Исполнитель может оставить 1 отклик на задачу:
- цена,
- комментарий,
- срок выполнения (дни).
2. Редактирование своего отклика до выбора исполнителя.
3. Удаление своего отклика до выбора исполнителя.
4. Заказчик видит список откликов к своей задаче.

### 5.6 Выбор исполнителя
1. Заказчик выбирает одного исполнителя из откликов.
2. После выбора:
- создается запись назначения,
- задача получает статус `IN_PROGRESS`,
- новые отклики запрещены.

### 5.7 Завершение задачи
1. Исполнитель отмечает задачу как «выполнено».
2. Заказчик подтверждает выполнение.
3. Задача получает статус `COMPLETED`.
4. Если заказчик отклоняет результат, статус возвращается в `IN_PROGRESS` с комментарием.

### 5.8 Статусы задач
Поддерживаемые статусы:
1. `OPEN` — открыта для откликов.
2. `IN_PROGRESS` — исполнитель выбран, работа идет.
3. `ON_REVIEW` — исполнитель отправил на проверку.
4. `COMPLETED` — заказчик подтвердил выполнение.
5. `CANCELED` — задача отменена заказчиком/админом.

### 5.9 Уведомления (MVP)
1. Внутри приложения:
- новый отклик по задаче заказчика,
- выбор исполнителя,
- смена статуса задачи.
2. Push через Telegram Bot API — опционально после MVP.

## 6. Нефункциональные требования
1. Производительность:
- время ответа API (p95) до 400 мс при нагрузке MVP.
2. Надежность:
- обработка ошибок с единым форматом ответа.
3. Безопасность:
- обязательная валидация `initData`,
- проверка прав доступа на каждый метод,
- rate limit на создание задач и откликов.
4. Логирование:
- входы, критичные действия, ошибки 4xx/5xx.
5. Масштабируемость:
- возможность вынести уведомления и чат в отдельные сервисы в будущем.

## 7. Предлагаемый стек
1. Frontend: React + Vite + TypeScript + Telegram WebApp SDK.
2. Backend: Node.js (Express или NestJS) + TypeScript.
3. DB: PostgreSQL.
4. ORM: Prisma (рекомендуется для скорости старта).
5. Хостинг: VPS/Render/Railway (любой managed вариант на старте).

## 8. Структура базы данных (минимум)
### 8.1 `users`
1. `id` (uuid, pk)
2. `telegram_id` (bigint, unique, not null)
3. `username` (varchar, null)
4. `display_name` (varchar, not null)
5. `role_flags` (jsonb, not null) — допускает обе роли
6. `is_blocked` (boolean, default false)
7. `created_at`, `updated_at`

### 8.2 `profiles`
1. `user_id` (uuid, pk/fk users.id)
2. `about` (text)
3. `skills` (text[])
4. `rating` (numeric(3,2), default 0)
5. `completed_tasks_count` (int, default 0)

### 8.3 `tasks`
1. `id` (uuid, pk)
2. `customer_id` (uuid, fk users.id, not null)
3. `title` (varchar, not null)
4. `description` (text, not null)
5. `budget` (numeric(12,2), not null)
6. `deadline_at` (timestamp, null)
7. `category` (varchar, not null)
8. `tags` (text[])
9. `status` (enum: OPEN/IN_PROGRESS/ON_REVIEW/COMPLETED/CANCELED)
10. `created_at`, `updated_at`

### 8.4 `proposals`
1. `id` (uuid, pk)
2. `task_id` (uuid, fk tasks.id, not null)
3. `executor_id` (uuid, fk users.id, not null)
4. `price` (numeric(12,2), not null)
5. `comment` (text, not null)
6. `eta_days` (int, not null)
7. `created_at`, `updated_at`
8. `unique(task_id, executor_id)`

### 8.5 `assignments`
1. `id` (uuid, pk)
2. `task_id` (uuid, fk tasks.id, unique, not null)
3. `customer_id` (uuid, fk users.id, not null)
4. `executor_id` (uuid, fk users.id, not null)
5. `selected_proposal_id` (uuid, fk proposals.id, not null)
6. `created_at`

### 8.6 `task_status_history`
1. `id` (uuid, pk)
2. `task_id` (uuid, fk tasks.id, not null)
3. `from_status` (enum, null)
4. `to_status` (enum, not null)
5. `changed_by` (uuid, fk users.id, not null)
6. `comment` (text, null)
7. `created_at`

## 9. API (черновой контракт)
### 9.1 Auth
1. `POST /auth/telegram` — логин по `initData`.
2. `GET /auth/me` — текущий пользователь.

### 9.2 Profile
1. `GET /profile/me`
2. `PATCH /profile/me`
3. `GET /profile/:userId`

### 9.3 Tasks
1. `POST /tasks`
2. `GET /tasks` (фильтры + пагинация)
3. `GET /tasks/:id`
4. `PATCH /tasks/:id` (только владелец, если `OPEN`)
5. `POST /tasks/:id/cancel`

### 9.4 Proposals
1. `POST /tasks/:id/proposals`
2. `GET /tasks/:id/proposals` (владелец задачи и автор отклика)
3. `PATCH /proposals/:id`
4. `DELETE /proposals/:id`

### 9.5 Assignment & Status
1. `POST /tasks/:id/select-proposal`
2. `POST /tasks/:id/send-to-review` (исполнитель)
3. `POST /tasks/:id/approve` (заказчик)
4. `POST /tasks/:id/reject-review` (заказчик)

### 9.6 Общий формат ошибок
```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "Budget must be greater than 0",
    "details": {}
  }
}
```

## 10. Бизнес-правила
1. Пользователь не может откликаться на свою задачу.
2. На задачу может быть назначен только один исполнитель.
3. После статуса `IN_PROGRESS` редактирование ключевых полей задачи запрещено.
4. После `COMPLETED` любые изменения задачи и откликов запрещены.
5. При блокировке пользователя:
- новые задачи и отклики запрещены,
- доступ к чтению своих данных остается.

## 11. UI-экраны MVP
1. Экран списка задач.
2. Экран создания/редактирования задачи.
3. Экран карточки задачи.
4. Экран откликов по задаче (для заказчика).
5. Экран моего отклика (для исполнителя).
6. Экран профиля (свой/чужой).
7. Экран «Мои задачи» (как заказчик и как исполнитель).

## 12. Этапы реализации
### Этап 1. База и авторизация (2-3 дня)
1. Поднять backend + db.
2. Реализовать `POST /auth/telegram`, `GET /auth/me`.
3. Подготовить базовые сущности `users`, `profiles`.

### Этап 2. Задачи и лента (3-4 дня)
1. CRUD задач.
2. Список задач с фильтрами/пагинацией.
3. Frontend: лента, создание, карточка.

### Этап 3. Отклики и выбор исполнителя (3-4 дня)
1. Создание/изменение/удаление отклика.
2. Выбор исполнителя и перевод в `IN_PROGRESS`.
3. Frontend: экран откликов и выбор.

### Этап 4. Завершение и полировка (2-3 дня)
1. `ON_REVIEW` -> `COMPLETED`.
2. Логирование, валидации, rate-limit.
3. Минимальная админ-функция блокировки.

Итого MVP: ориентировочно 10-14 рабочих дней.

## 13. Критерии приемки MVP
1. Пользователь может войти только через Telegram, и подпись `initData` проходит валидацию.
2. Заказчик может создать задачу и увидеть ее в списке.
3. Исполнитель может оставить отклик.
4. Заказчик может выбрать исполнителя.
5. Исполнитель может отправить задачу на проверку.
6. Заказчик может подтвердить выполнение.
7. Все ключевые действия отражаются в статусах задачи и истории статусов.
8. Базовые негативные сценарии (нет прав, невалидные данные, повторные действия) корректно обрабатываются.

## 14. Что не входит в MVP
1. Безопасная сделка/эскроу.
2. Встроенный чат в реальном времени.
3. Полноценная система рейтингов и отзывов.
4. Мультиязычность.
5. Сложная модерация контента (AI/автофильтры).

## 15. Риски и допущения
1. Telegram может ограничивать поведение WebApp в разных клиентах; нужна проверка на iOS/Android/Desktop.
2. Без эскроу оплата остается вне платформы, это снижает доверие и контроль споров.
3. На этапе MVP нагрузка малая, поэтому допускается монолитная архитектура.
